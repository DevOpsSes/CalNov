# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
# permissions:
#       checks: write
#       contents: read
#       packages: write
jobs:
  Setup:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Maven Clean
      run: mvn -B clean --file pom.xml
  Compile:
    needs: Setup
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Maven Compile
      run: mvn -B compile --file pom.xml
  StaticAnalysis:
    needs: Compile
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    # - name: Cache SonarCloud packages
    #   uses: actions/cache@v4
    #   with:
    #     path: ~/.sonar/cache
    #     key: ${{ runner.os }}-sonar
    #     restore-keys: ${{ runner.os }}-sonar
    # - name: Cache Maven packages
    #   uses: actions/cache@v4
    #   with:
    #     path: ~/.m2
    #     key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    #     restore-keys: ${{ runner.os }}-m2  
    - name: SonarCloud scan
      run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
      env:
        github-token: ${{ secrets.GH_TOKEN }}
        sonar-token: ${{ secrets.SONAR_TOKEN }}

  UnitTesting:
    needs: Compile
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: read
      packages: write
        
    steps:
    - run: echo should run unit tests
    - uses: actions/checkout@v4
    - name: Maven test
      run: mvn -B test --file pom.xml
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
       files: target/surefire-reports/*.xml
  CodeCoverage:
    runs-on: ubuntu-latest
    needs: UnitTesting
    permissions:
      checks: write
      contents: read
      packages: write
        
    steps:
    - run: echo should run code coverage
    - uses: actions/checkout@v4
    - name: Maven CC
      run: mvn -X org.jacoco:jacoco-maven-plugin:report
  War:
    runs-on: ubuntu-latest
    needs: CodeCoverage
    permissions:
      checks: write
      contents: read
      packages: write
        
    steps:
    - run: echo should run war
    - uses: actions/checkout@v4
    - name: Maven war
      run: mvn -X war:war
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp
        path: target/*.war
  
  deploy:
    runs-on: ubuntu-latest
    needs: War
    permissions:
      checks: write
      contents: read
      packages: write
        
    steps:
       - uses: actions/checkout@v2
       - name: Set up JDK 11
         uses: actions/setup-java@v2
         with:
           java-version: '11'
           distribution: 'adopt'
           server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
           settings-path: ${{ github.workspace }} # location for the settings.xml file
       - name: Download Artifact
         uses: actions/download-artifact@v4
         with:
           name: webapp
           path: target/
       - name: Publish in GitHub package
         run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml
         env:
           GITHUB_TOKEN: ${{ github.token }}
    
       - name: Login to Docker Hub
         uses: docker/login-action@v3
         with:
          username: ${{ vars.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
       - name: Set up QEMU
         uses: docker/setup-qemu-action@v3
      
       - name: Set up Docker Buildx
         uses: docker/setup-buildx-action@v3
      
       - name: Build and push
         uses: docker/build-push-action@v6
         with:
          push: true
          tags: |
            madhurimabb/backstagedemo:latest
            madhurimabb/backstagedemo:${{ github.run_number }}
          context: . 
  
   
  
    
     



    # # Optional: Uploads the full dependency graph to GitHub to improve the quality of Dependabot alerts this repository can receive
    # - name: Update dependency graph
    #   uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
